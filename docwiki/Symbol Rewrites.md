![[docwiki/screenshots/Symbol Rewrites.png]]

### Grammar

![[docwiki/Code/symrewrites.ohm.m4]]

This grammar extends the grammar `prolog.ohm.inc` and pattern matches for 11 more kinds of symbols that are legal in Scheme, but, not legal in JavaScript, like `#t`, `var?`, etc.  Each match is tagged uniquely and then passed on to the rewrite specification.

Using Ohm-JS syntax, the `:=` operator is used to redefine the meaning of the pattern `Symbol`.  The `-- <symbol>` trailing syntax defines unique tags for each branch of the pattern.
### Rewrite

![[docwiki/Code/symrewrites.rwr.mr]]

This rewrite specification corresponds to all patterns matched by the extended `Symbol` pattern in the above grammar.  

The unique tags are represented by function identifiers, for example the `| sym<"#t"> -- true` grammar rule corresponds with the rewrite rule `Symbol_true`.

Each pattern is rewritten in a form that emits legal JavaScript syntax, for example, `#t` is rewritten as `trueₓ` and `var?` is rewritten as `isVarₓ`.  We are careful to add virtual comma suffixes "`ₓ`" to all rewritten words so that downstream passes can easily differentiate these rewritten words from other words in the code. 

The catch-all is the final line `sym [s vcomma?] = ‛«s»«vcomma»’` which passes unmatched words on "as is", with and without virtual commas.  

The rewrite spec syntax `«...»` evaluates the enclosed variable (usually a match tree supplied by the grammar pattern matcher) and inserts it into the generated string.  When matches employ one of the repetition operators `?/*/+`, the repetition trees are fully evaluated and their results are combined into single strings.  For example, in the above catch-all, if a virtual comma appears in the input, it is copied to the output.  If there is no virtual comma, then the tree evaluator returns the empty string in place of `vcomma`.  The virtual comma is specified, in the grammar and in the rewrite spec, as being optional - `vcomma?` - which results in a pattern match tree containing 0 or 1 children.  If the tree contains 1 child, the string generated by the child is used.  If the tree contains 0 children, then the empty string is used.